"use strict";(self.webpackChunkrke_docs=self.webpackChunkrke_docs||[]).push([[3831],{7300:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>g,frontMatter:()=>l,metadata:()=>c,toc:()=>u});var s=r(5893),t=r(1151),o=r(4866),i=r(5162);const l={title:"K8s Ingress Controllers",description:"By default, RKE deploys the NGINX ingress controller. Learn how to schedule and disable default k8s ingress controllers, and how to configure NGINX controller"},a=void 0,c={id:"config-options/add-ons/ingress-controllers/ingress-controllers",title:"K8s Ingress Controllers",description:"By default, RKE deploys the NGINX ingress controller. Learn how to schedule and disable default k8s ingress controllers, and how to configure NGINX controller",source:"@site/docs/config-options/add-ons/ingress-controllers/ingress-controllers.md",sourceDirName:"config-options/add-ons/ingress-controllers",slug:"/config-options/add-ons/ingress-controllers/",permalink:"/config-options/add-ons/ingress-controllers/",draft:!1,unlisted:!1,editUrl:"https://github.com/rancher/rke1-docs/edit/main/docs/config-options/add-ons/ingress-controllers/ingress-controllers.md",tags:[],version:"current",lastUpdatedAt:1704844723,formattedLastUpdatedAt:"Jan 9, 2024",frontMatter:{title:"K8s Ingress Controllers",description:"By default, RKE deploys the NGINX ingress controller. Learn how to schedule and disable default k8s ingress controllers, and how to configure NGINX controller"},sidebar:"mySidebar",previous:{title:"DNS providers",permalink:"/config-options/add-ons/dns/"},next:{title:"Metrics Server",permalink:"/config-options/add-ons/metrics-server/"}},d={},u=[{value:"Default Ingress",id:"default-ingress",level:3},{value:"Scheduling Ingress Controllers",id:"scheduling-ingress-controllers",level:3},{value:"Ingress Priority Class Name",id:"ingress-priority-class-name",level:3},{value:"Tolerations",id:"tolerations",level:3},{value:"Disabling the Default Ingress Controller",id:"disabling-the-default-ingress-controller",level:3},{value:"Configuring NGINX Ingress Controller",id:"configuring-nginx-ingress-controller",level:3},{value:"Disabling NGINX Ingress Default Backend",id:"disabling-nginx-ingress-default-backend",level:3},{value:"Configuring network options",id:"configuring-network-options",level:3},{value:"Configuring an NGINX Default Certificate",id:"configuring-an-nginx-default-certificate",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"default-ingress",children:"Default Ingress"}),"\n",(0,s.jsx)(n.p,{children:"By default, RKE deploys the NGINX ingress controller on all schedulable nodes."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"As of v0.1.8, only workers are considered schedulable nodes, but before v0.1.8, worker and controlplane nodes were considered schedulable nodes."})}),"\n",(0,s.jsxs)(n.p,{children:["RKE will deploy the ingress controller as a DaemonSet with ",(0,s.jsx)(n.code,{children:"hostNetwork: true"}),", so ports ",(0,s.jsx)(n.code,{children:"80"}),", and ",(0,s.jsx)(n.code,{children:"443"})," will be opened on each node where the controller is deployed."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["As of v1.1.11, the network options of the ingress controller are configurable. See ",(0,s.jsx)(n.a,{href:"#configuring-network-options",children:"Configuring network options"}),"."]})}),"\n",(0,s.jsxs)(n.p,{children:["The images used for ingress controller is under the ",(0,s.jsxs)(n.a,{href:"/config-options/system-images/",children:[(0,s.jsx)(n.code,{children:"system_images"})," directive"]}),". For each Kubernetes version, there are default images associated with the ingress controller, but these can be overridden by changing the image tag in ",(0,s.jsx)(n.code,{children:"system_images"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"scheduling-ingress-controllers",children:"Scheduling Ingress Controllers"}),"\n",(0,s.jsxs)(n.p,{children:["If you only wanted ingress controllers to be deployed on specific nodes, you can set a ",(0,s.jsx)(n.code,{children:"node_selector"})," for the ingress. The label in the ",(0,s.jsx)(n.code,{children:"node_selector"})," would need to match the label on the nodes for the ingress controller to be deployed."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"nodes:\n- address: 1.1.1.1\n  role: [controlplane,worker,etcd]\n  user: root\n  labels:\n    app: ingress\n\ningress:\n  provider: nginx\n  node_selector:\n    app: ingress\n"})}),"\n",(0,s.jsx)(n.h3,{id:"ingress-priority-class-name",children:"Ingress Priority Class Name"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Available as of RKE v1.2.6+"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/#pod-priority",children:"pod priority"})," is set by configuring a priority class name:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"ingress:\n  provider: nginx\n  ingress_priority_class_name: system-cluster-critical\n"})}),"\n",(0,s.jsx)(n.h3,{id:"tolerations",children:"Tolerations"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Available as of v1.2.4"})}),"\n",(0,s.jsxs)(n.p,{children:["The configured tolerations apply to the ",(0,s.jsx)(n.code,{children:"default-http-backend"})," Deployment."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'ingress:\n  tolerations:\n  - key: "node.kubernetes.io/unreachable"\n    operator: "Exists"\n    effect: "NoExecute"\n    tolerationseconds: 300\n  - key: "node.kubernetes.io/not-ready"\n    operator: "Exists"\n    effect: "NoExecute"\n    tolerationseconds: 300\n'})}),"\n",(0,s.jsxs)(n.p,{children:["To check for applied tolerations ",(0,s.jsx)(n.code,{children:"default-http-backend"})," Deployment, use the following commands:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl -n ingress-nginx get deploy default-http-backend -o jsonpath='{.spec.template.spec.tolerations}'\n"})}),"\n",(0,s.jsx)(n.h3,{id:"disabling-the-default-ingress-controller",children:"Disabling the Default Ingress Controller"}),"\n",(0,s.jsxs)(n.p,{children:["You can disable the default controller by specifying ",(0,s.jsx)(n.code,{children:"none"})," to  the ingress ",(0,s.jsx)(n.code,{children:"provider"})," directive in the cluster configuration."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"ingress:\n    provider: none\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configuring-nginx-ingress-controller",children:"Configuring NGINX Ingress Controller"}),"\n",(0,s.jsxs)(n.p,{children:["For the configuration of NGINX, there are configuration options available in Kubernetes. There are a ",(0,s.jsx)(n.a,{href:"https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md",children:"list of options for the NGINX config map"})," , ",(0,s.jsx)(n.a,{href:"https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/cli-arguments.md",children:"command line extra_args"})," and ",(0,s.jsx)(n.a,{href:"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/",children:"annotations"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'ingress:\n  provider: nginx\n  options:\n    map-hash-bucket-size: "128"\n    ssl-protocols: SSLv2\n  extra_args:\n    enable-ssl-passthrough: ""\n'})}),"\n",(0,s.jsx)(n.h3,{id:"disabling-nginx-ingress-default-backend",children:"Disabling NGINX Ingress Default Backend"}),"\n",(0,s.jsxs)(n.p,{children:["As of v0.20.0, you can disable the ",(0,s.jsx)(n.a,{href:"https://kubernetes.github.io/ingress-nginx/user-guide/default-backend/",children:"default backend service"})," for the ingress controller. This is possible because ",(0,s.jsx)(n.code,{children:"ingress-nginx"})," will fall back to a local 404 page, and does not require a backend service. The service can be enabled/disabled with a boolean value."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"ingress:\n  default_backend: false\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"What happens if the field is omitted?",type:"info",children:(0,s.jsxs)(n.p,{children:["The value of ",(0,s.jsx)(n.code,{children:"default_backend"})," will default to ",(0,s.jsx)(n.code,{children:"true"}),". This maintains behavior with older versions of ",(0,s.jsx)(n.code,{children:"rke"}),". However, a future version of ",(0,s.jsx)(n.code,{children:"rke"})," will change the default value to ",(0,s.jsx)(n.code,{children:"false"}),"."]})}),"\n",(0,s.jsx)(n.h3,{id:"configuring-network-options",children:"Configuring network options"}),"\n",(0,s.jsxs)(o.Z,{children:[(0,s.jsx)(i.Z,{value:"v1.3.x",children:(0,s.jsxs)(n.p,{children:["For Kubernetes v1.21 and up, the NGINX ingress controller no longer runs in ",(0,s.jsx)(n.code,{children:"hostNetwork: true"})," but uses hostPorts for port ",(0,s.jsx)(n.code,{children:"80"})," and port ",(0,s.jsx)(n.code,{children:"443"}),". This was done so the admission webhook can be configured to be accessed using ClusterIP so it can only be reached inside the cluster. If you want to change the mode and/or the ports, see the options below."]})}),(0,s.jsx)(i.Z,{value:"v1.1.11 and up & v1.2.x",children:(0,s.jsxs)(n.p,{children:["By default, the nginx ingress controller is configured using ",(0,s.jsx)(n.code,{children:"hostNetwork: true"})," on the default ports ",(0,s.jsx)(n.code,{children:"80"})," and ",(0,s.jsx)(n.code,{children:"443"}),". If you want to change the mode and/or the ports, see the options below."]})})]}),"\n",(0,s.jsxs)(n.p,{children:["Here's an example of how to configure the nginx ingress controller using ",(0,s.jsx)(n.code,{children:"hostPort"})," and override the default ports:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"ingress:\n  provider: nginx\n  network_mode: hostPort\n  http_port: 9090\n  https_port: 9443\n  extra_args:\n    http-port: 3080\n    https-port: 3443\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Here's an example of how to configure the nginx ingress controller using ",(0,s.jsx)(n.code,{children:"hostNetwork"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"ingress:\n  provider: nginx\n  network_mode: hostNetwork\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Here's an example of how to configure the nginx ingress controller with no network mode which will make it run on the overlay network (for example, if you want to expose the nginx ingress controller using a ",(0,s.jsx)(n.code,{children:"LoadBalancer"}),") and override the default ports:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"ingress:\n  provider: nginx\n  network_mode: none\n  extra_args:\n    http-port: 8080\n    https-port: 8443\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configuring-an-nginx-default-certificate",children:"Configuring an NGINX Default Certificate"}),"\n",(0,s.jsx)(n.p,{children:"When configuring an ingress object with TLS termination, you must provide it with a certificate used for encryption/decryption. Instead of explicitly defining a certificate each time you configure an ingress, you can set up a custom certificate that's used by default."}),"\n",(0,s.jsx)(n.p,{children:"Setting up a default certificate is especially helpful in environments where a wildcard certificate is used, as the certificate can be applied in multiple subdomains."}),"\n",(0,s.jsx)(n.admonition,{title:"Prerequisites",type:"note",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Access to the ",(0,s.jsx)(n.code,{children:"cluster.yml"})," used to create the cluster."]}),"\n",(0,s.jsx)(n.li,{children:"The PEM encoded certificate you will use as the default certificate."}),"\n"]})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Obtain or generate your certificate key pair in a PEM encoded form."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Generate a Kubernetes secret from your PEM encoded certificate with the following command, substituting your certificate for ",(0,s.jsx)(n.code,{children:"mycert.cert"})," and ",(0,s.jsx)(n.code,{children:"mycert.key"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl -n ingress-nginx create secret tls ingress-default-cert --cert=mycert.cert --key=mycert.key -o yaml --dry-run=true > ingress-default-cert.yaml\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Include the contents of ",(0,s.jsx)(n.code,{children:"ingress-default-cert.yml"})," inline with your RKE ",(0,s.jsx)(n.code,{children:"cluster.yml"})," file. For example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"addons: |-\n  ---\n  apiVersion: v1\n  data:\n    tls.crt: [ENCODED CERT]\n    tls.key: [ENCODED KEY]\n  kind: Secret\n  metadata:\n    creationTimestamp: null\n    name: ingress-default-cert\n    namespace: ingress-nginx\n  type: kubernetes.io/tls\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Define your ingress resource with the following ",(0,s.jsx)(n.code,{children:"default-ssl-certificate"})," argument, which references the secret we created earlier under ",(0,s.jsx)(n.code,{children:"extra_args"})," in your ",(0,s.jsx)(n.code,{children:"cluster.yml"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'ingress:\n  provider: "nginx"\n  extra_args:\n    default-ssl-certificate: "ingress-nginx/ingress-default-cert"\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Optional:"})," If you want to apply the default certificate to ingresses in a cluster that already exists, you must delete the NGINX ingress controller pods to have Kubernetes schedule new pods with the newly configured ",(0,s.jsx)(n.code,{children:"extra_args"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl delete pod -l app=ingress-nginx -n ingress-nginx\n"})}),"\n"]}),"\n"]})]})}function g(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},5162:(e,n,r)=>{r.d(n,{Z:()=>i});r(7294);var s=r(4334);const t={tabItem:"tabItem_Ymn6"};var o=r(5893);function i(e){let{children:n,hidden:r,className:i}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,s.Z)(t.tabItem,i),hidden:r,children:n})}},4866:(e,n,r)=>{r.d(n,{Z:()=>w});var s=r(7294),t=r(4334),o=r(2466),i=r(6550),l=r(469),a=r(1980),c=r(7392),d=r(12);function u(e){return s.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:r}=e;return(0,s.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:r,attributes:s,default:t}}=e;return{value:n,label:r,attributes:s,default:t}}))}(r);return function(e){const n=(0,c.l)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,r])}function g(e){let{value:n,tabValues:r}=e;return r.some((e=>e.value===n))}function p(e){let{queryString:n=!1,groupId:r}=e;const t=(0,i.k6)(),o=function(e){let{queryString:n=!1,groupId:r}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:n,groupId:r});return[(0,a._X)(o),(0,s.useCallback)((e=>{if(!o)return;const n=new URLSearchParams(t.location.search);n.set(o,e),t.replace({...t.location,search:n.toString()})}),[o,t])]}function f(e){const{defaultValue:n,queryString:r=!1,groupId:t}=e,o=h(e),[i,a]=(0,s.useState)((()=>function(e){let{defaultValue:n,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!g({value:n,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${r.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const s=r.find((e=>e.default))??r[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:o}))),[c,u]=p({queryString:r,groupId:t}),[f,x]=function(e){let{groupId:n}=e;const r=function(e){return e?`docusaurus.tab.${e}`:null}(n),[t,o]=(0,d.Nk)(r);return[t,(0,s.useCallback)((e=>{r&&o.set(e)}),[r,o])]}({groupId:t}),m=(()=>{const e=c??f;return g({value:e,tabValues:o})?e:null})();(0,l.Z)((()=>{m&&a(m)}),[m]);return{selectedValue:i,selectValue:(0,s.useCallback)((e=>{if(!g({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);a(e),u(e),x(e)}),[u,x,o]),tabValues:o}}var x=r(2389);const m={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=r(5893);function j(e){let{className:n,block:r,selectedValue:s,selectValue:i,tabValues:l}=e;const a=[],{blockElementScrollPositionUntilNextRender:c}=(0,o.o5)(),d=e=>{const n=e.currentTarget,r=a.indexOf(n),t=l[r].value;t!==s&&(c(n),i(t))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const r=a.indexOf(e.currentTarget)+1;n=a[r]??a[0];break}case"ArrowLeft":{const r=a.indexOf(e.currentTarget)-1;n=a[r]??a[a.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,t.Z)("tabs",{"tabs--block":r},n),children:l.map((e=>{let{value:n,label:r,attributes:o}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:s===n?0:-1,"aria-selected":s===n,ref:e=>a.push(e),onKeyDown:u,onClick:d,...o,className:(0,t.Z)("tabs__item",m.tabItem,o?.className,{"tabs__item--active":s===n}),children:r??n},n)}))})}function y(e){let{lazy:n,children:r,selectedValue:t}=e;const o=(Array.isArray(r)?r:[r]).filter(Boolean);if(n){const e=o.find((e=>e.props.value===t));return e?(0,s.cloneElement)(e,{className:"margin-top--md"}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:o.map(((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==t})))})}function v(e){const n=f(e);return(0,b.jsxs)("div",{className:(0,t.Z)("tabs-container",m.tabList),children:[(0,b.jsx)(j,{...e,...n}),(0,b.jsx)(y,{...e,...n})]})}function w(e){const n=(0,x.Z)();return(0,b.jsx)(v,{...e,children:u(e.children)},String(n))}},1151:(e,n,r)=>{r.d(n,{Z:()=>l,a:()=>i});var s=r(7294);const t={},o=s.createContext(t);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);